name: Sync docs to component READMEs And Translate

permissions:
  contents: write

concurrency:
  group: docs-translation
  cancel-in-progress: false

on:
  push:
    paths:
      - 'components/**/*.md'
  workflow_dispatch:

jobs:

  # ------------------------------------------------------------
  # Skip workflow if last commit was made by bot
  # ------------------------------------------------------------
  check-bot:
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.check.outputs.skip }}
    steps:
      - uses: actions/checkout@v4
      - id: check
        run: |
          AUTHOR=$(git log -1 --pretty=format:'%an')
          if [ "$AUTHOR" = "gemini-bot" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

  # ------------------------------------------------------------
  # Detect changed components
  # ------------------------------------------------------------
  detect:
    needs: check-bot
    if: needs.check-bot.outputs.skip != 'true'
    runs-on: ubuntu-latest
    outputs:
      server: ${{ steps.filter.outputs.server }}
      client: ${{ steps.filter.outputs.client }}
      monitoring: ${{ steps.filter.outputs.monitoring }}
      trans: ${{ steps.filter.outputs.trans }}
      overview: ${{ steps.filter.outputs.overview }}

    steps:
      - uses: actions/checkout@v4

      - name: Detect changed paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            server: ['components/server/server.md']
            client: ['components/client/client.md']
            monitoring: ['components/monitoring-server/monitoring-server.md']
            trans: ['components/trans-tester/trans-tester.md']
            overview: ['components/platform/overview.md']


  # ------------------------------------------------------------
  # Translate only changed lines (cost optimized)
  # ------------------------------------------------------------
  translate:
    needs: detect
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2  # required for git diff HEAD^

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Gemini SDK
        run: pip install -U google-genai

      - name: Translate changed lines and inject docs links
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python - <<EOF
          import os
          import subprocess
          from google import genai

          client = genai.Client(
              api_key=os.environ['GEMINI_API_KEY'],
              http_options={'api_version': 'v1'}
          )

          MODEL_ID = "gemini-2.5-flash-lite"

          def get_changed_lines(file_path):
              try:
                  diff = subprocess.check_output(
                      ["git", "diff", "HEAD^", "HEAD", "--", file_path],
                      text=True
                  )
              except:
                  return []

              changed = []
              for line in diff.splitlines():
                  if line.startswith("+") and not line.startswith("+++"):
                      changed.append(line[1:])
              return changed


          def translate_text(text):
              try:
                  response = client.models.generate_content(
                      model=MODEL_ID,
                      contents=f"Translate into Korean:\n\n{text}"
                  )
                  return response.text if response.text else text
              except:
                  return text


          for root, dirs, files in os.walk("components"):
              for file in files:
                  if not file.endswith(".md") or file.endswith(".kr.md"):
                      continue

                  en_path = os.path.join(root, file)
                  kr_path = en_path.replace(".md", ".kr.md")

                  changed_lines = get_changed_lines(en_path)
                  if not changed_lines:
                      continue

                  print(f"Processing {en_path}")

                  with open(en_path, "r", encoding="utf-8") as f:
                      en_content = f.read()

                  component = en_path.split("/")[1]
                  docs_en_url = f"https://github.com/seyun4047/drone-platform-docs/blob/main/components/{component}/{component}.md"
                  docs_kr_url = f"https://github.com/seyun4047/drone-platform-docs/blob/main/components/{component}/{component}.kr.md"

                  # If KR file doesn't exist â†’ translate full file
                  if not os.path.exists(kr_path):
                      translated = translate_text(en_content)
                      header = f"Original English Document: [{component}.md]({docs_en_url})\n\n---\n\n"
                      with open(kr_path, "w", encoding="utf-8") as f:
                          f.write(header + translated)
                      continue

                  # Otherwise patch changed lines only
                  with open(kr_path, "r", encoding="utf-8") as f:
                      kr_content = f.read()

                  for line in changed_lines:
                      if line.strip() == "":
                          continue
                      translated_line = translate_text(line)
                      kr_content = kr_content.replace(line, translated_line)

                  with open(kr_path, "w", encoding="utf-8") as f:
                      f.write(kr_content)

                  # Inject Korean docs link into EN file if missing
                  with open(en_path, "r", encoding="utf-8") as f:
                      original_en = f.read()

                  if not original_en.startswith("Korean version:"):
                      header = f"Korean version: [{component}.kr.md]({docs_kr_url})\n\n---\n\n"
                      with open(en_path, "w", encoding="utf-8") as f:
                          f.write(header + original_en)

          EOF

      - name: Commit translations
        run: |
          git config user.name "gemini-bot"
          git config user.email "actions@github.com"
          git add components/**/*.md
          git commit -m "docs: partial translation update" || echo "No changes"
          git pull --rebase origin main
          git push


  # ------------------------------------------------------------
  # Sync README files to component repositories
  # ------------------------------------------------------------
  sync:
    needs: translate
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - repo: drone-platform-server
            component: server
          - repo: drone-platform-client
            component: client
          - repo: drone-platform-monitoring-server
            component: monitoring-server
          - repo: drone-platform-trans-tester
            component: trans-tester

    steps:
      - uses: actions/checkout@v4

      - name: Build final README files
        run: |
          COMP=${{ matrix.component }}
          REPO=${{ matrix.repo }}

          REPO_EN_URL="https://github.com/seyun4047/$REPO/blob/main/README.md"
          REPO_KR_URL="https://github.com/seyun4047/$REPO/blob/main/README.kr.md"

          # English README
          echo "Korean version: [$REPO_KR_URL]($REPO_KR_URL)" > README.md
          echo -e "\n---\n" >> README.md
          cat components/$COMP/$COMP.md >> README.md

          # Korean README
          echo "Original English Document: [$REPO_EN_URL]($REPO_EN_URL)" > README.kr.md
          echo -e "\n---\n" >> README.kr.md

          if [ -f components/$COMP/$COMP.kr.md ]; then
            cat components/$COMP/$COMP.kr.md >> README.kr.md
          else
            cat components/$COMP/$COMP.md >> README.kr.md
          fi

      - name: Clone target repository
        run: |
          git clone https://x-access-token:${{ secrets.DOCS_PUSH_TOKEN }}@github.com/seyun4047/${{ matrix.repo }}.git target

      - name: Push README files
        run: |
          cp README.md target/README.md
          cp README.kr.md target/README.kr.md
          cd target
          git config user.name "gemini-bot"
          git config user.email "actions@github.com"
          git add README.md README.kr.md
          git commit -m "docs: sync README & KR translation" || echo "No changes"
          git push
