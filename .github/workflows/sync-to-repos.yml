name: Sync docs to component READMEs And Translate

permissions:
  contents: write

on:
  push:
    paths:
      - 'components/**/*.md'
  workflow_dispatch:

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      server: ${{ steps.filter.outputs.server }}
      client: ${{ steps.filter.outputs.client }}
      monitoring: ${{ steps.filter.outputs.monitoring }}
      trans: ${{ steps.filter.outputs.trans }}
      overview: ${{ steps.filter.outputs.overview }}

    steps:
      - uses: actions/checkout@v4

      - name: Detect changed paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            server: ['components/server/server.md']
            client: ['components/client/client.md']
            monitoring: ['components/monitoring-server/monitoring-server.md']
            trans: ['components/trans-tester/trans-tester.md']
            overview: ['components/platform/overview.md']

  translate-and-sync:
    needs: detect
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - repo: drone-platform-server
            component: server
            output_key: server
          - repo: drone-platform-client
            component: client
            output_key: client
          - repo: drone-platform-monitoring-server
            component: monitoring-server
            output_key: monitoring
          - repo: drone-platform-trans-tester
            component: trans-tester
            output_key: trans

    steps:
      - uses: actions/checkout@v4

      - name: Check if this matrix entry needs processing
        id: check
        run: |
          COMP_CHANGED="${{ needs.detect.outputs[matrix.output_key] }}"
          OVERVIEW_CHANGED="${{ needs.detect.outputs.overview }}"
          if [ "$COMP_CHANGED" = "true" ] || [ "$OVERVIEW_CHANGED" = "true" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Python
        if: steps.check.outputs.should_run == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Gemini SDK
        if: steps.check.outputs.should_run == 'true'
        run: pip install -U google-genai

      - name: Translate changed files
        if: steps.check.outputs.should_run == 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          COMP_CHANGED: ${{ needs.detect.outputs[matrix.output_key] }}
          OVERVIEW_CHANGED: ${{ needs.detect.outputs.overview }}
          COMPONENT: ${{ matrix.component }}
        run: |
          python - <<EOF
          import os
          from google import genai

          client = genai.Client(
              api_key=os.environ['GEMINI_API_KEY'],
              http_options={'api_version': 'v1'}
          )

          MODEL_ID = "gemini-2.5-flash"

          comp = os.environ['COMPONENT']
          comp_changed = os.environ.get("COMP_CHANGED") == "true"
          overview_changed = os.environ.get("OVERVIEW_CHANGED") == "true"

          def translate_file(en_path, kr_path):
              if not os.path.exists(en_path):
                  print(f"[SKIP] {en_path} not found")
                  return

              with open(en_path, "r", encoding="utf-8") as f:
                  en_content = f.read()

              prompt = f"""
              Translate the following Markdown documentation into Korean.
              Keep markdown structure, links, and code blocks intact.
              Translate only descriptive text.

              {en_content}
              """

              try:
                  response = client.models.generate_content(
                      model=MODEL_ID,
                      contents=prompt
                  )
                  kr_content = response.text if response.text else en_content
              except Exception as e:
                  print(f"[ERROR] Translation failed: {e}")
                  kr_content = en_content

              with open(kr_path, "w", encoding="utf-8") as f:
                  f.write(kr_content)
              print(f"[OK] Translated {en_path} -> {kr_path}")

          if comp_changed:
              translate_file(
                  f"components/{comp}/{comp}.md",
                  f"components/{comp}/{comp}.kr.md"
              )

          if overview_changed:
              translate_file(
                  "components/platform/overview.md",
                  "components/platform/overview.kr.md"
              )
          EOF

      - name: Build Final READMEs
        if: steps.check.outputs.should_run == 'true'
        run: |
          COMP=${{ matrix.component }}
          BASE_URL="https://github.com/seyun4047/${{ matrix.repo }}/blob/main"

          echo "Korean version: [한국어 문서]($BASE_URL/README.kr.md)" > README.md
          echo -e "\n---\n" >> README.md
          cat components/$COMP/$COMP.md >> README.md
          echo -e "\n\n---\n" >> README.md
          cat components/platform/overview.md >> README.md

          echo "해당 문서는 gemini-2.5-flash 로 자동 번역되었습니다.<br>정확한 내용은 여기서 확인해주세요: [English Document]($BASE_URL/README.md)" > README.kr.md
          echo -e "\n---\n" >> README.kr.md
          cat components/$COMP/$COMP.kr.md >> README.kr.md
          echo -e "\n\n---\n" >> README.kr.md
          cat components/platform/overview.kr.md >> README.kr.md

      - name: Clone target repo
        if: steps.check.outputs.should_run == 'true'
        run: |
          git clone https://x-access-token:${{ secrets.DOCS_PUSH_TOKEN }}@github.com/seyun4047/${{ matrix.repo }}.git target

      - name: Sync
        if: steps.check.outputs.should_run == 'true'
        run: |
          cp README.md target/README.md
          cp README.kr.md target/README.kr.md
          cd target
          git config user.name "gemini-bot"
          git config user.email "actions@github.com"
          git add README.md README.kr.md
          git commit -m "docs: sync README & KR translation" || echo "No changes"
          git push

      - name: Commit translations back to source repo
        if: steps.check.outputs.should_run == 'true'
        run: |
          git config user.name "gemini-bot"
          git config user.email "actions@github.com"
          git add components/**/*.kr.md
          git diff --cached --quiet || git commit -m "docs: auto translate"
          git push