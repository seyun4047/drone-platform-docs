name: Translate Docs and Sync to Component Repos

on:
  push:
    branches:
      - main
    paths:
      - overview.md
      - components/**/*.md
  workflow_dispatch:

permissions:
  contents: write

jobs:
  translate-and-sync:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - repo: drone-platform-server
            component: server
          - repo: drone-platform-client
            component: client
          - repo: drone-platform-monitoring-server
            component: monitoring-server
          - repo: drone-platform-trans-tester
            component: trans-tester

    steps:
      - name: Checkout docs repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Gemini SDK
        run: pip install google-generativeai

      # =========================================================
      # 1️⃣ TRANSLATION + BIDIRECTIONAL LINK INJECTION
      # =========================================================
      - name: Translate and inject links
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python << 'EOF'
          import os
          import google.generativeai as genai

          genai.configure(api_key=os.environ["GEMINI_API_KEY"])
          model = genai.GenerativeModel("gemini-2.5-flash-lite")

          component = "${{ matrix.component }}"
          en_path = f"components/{component}/{component}.md"
          kr_path = f"components/{component}/{component}.kr.md"

          if not os.path.exists(en_path):
              exit()

          def translate_text(text):
              prompt = f"""
              Translate the following Markdown documentation into Korean.

              Rules:
              - Preserve markdown formatting
              - Do NOT translate code blocks
              - Keep headings structure unchanged

              Markdown:
              {text}
              """
              response = model.generate_content(prompt)
              return response.text

          # Repo URLs
          en_repo_url = f"https://github.com/seyun4047/drone-platform-{component}/blob/main/README.md"
          kr_repo_url = f"https://github.com/seyun4047/drone-platform-{component}/blob/main/README.kr.md"

          # --------------------------
          # Inject KR link into EN
          # --------------------------
          with open(en_path, "r", encoding="utf-8") as f:
              en_content = f.read()

          if not en_content.startswith("https://github.com"):
              en_content = kr_repo_url + "\n\n---\n\n" + en_content
              with open(en_path, "w", encoding="utf-8") as f:
                  f.write(en_content)

          # Reload EN content
          with open(en_path, "r", encoding="utf-8") as f:
              en_content = f.read()

          # --------------------------
          # Build KR header
          # --------------------------
          kr_header = (
              f"해당 문서는 gemini-2.5-flash-lite 로 자동 번역되어 부자연스러운 부분이 있을 수 있으니,<br>"
              f"정확한 내용을 여기서 확인해주세요. : [영어 문서]({en_repo_url})\n\n---\n\n"
          )

          # --------------------------
          # Translate if KR missing
          # --------------------------
          if not os.path.exists(kr_path):
              translated = translate_text(en_content)
              with open(kr_path, "w", encoding="utf-8") as f:
                  f.write(kr_header + translated)
          else:
              with open(kr_path, "r", encoding="utf-8") as f:
                  kr_content = f.read()

              if not kr_content.startswith("해당 문서는 gemini"):
                  kr_content = kr_header + kr_content
                  with open(kr_path, "w", encoding="utf-8") as f:
                      f.write(kr_content)

          EOF

      # =========================================================
      # 2️⃣ BUILD README FILES
      # =========================================================
      - name: Build English README
        run: |
          echo "" > README.md
          cat components/${{ matrix.component }}/${{ matrix.component }}.md >> README.md
          echo "" >> README.md
          cat overview.md >> README.md

      - name: Build Korean README
        run: |
          if [ -f components/${{ matrix.component }}/${{ matrix.component }}.kr.md ]; then
            echo "" > README.kr.md
            cat components/${{ matrix.component }}/${{ matrix.component }}.kr.md >> README.kr.md
            echo "" >> README.kr.md
            cat components/platform/overview.md >> README.kr.md
          fi

      # =========================================================
      # 3️⃣ CLONE TARGET REPO
      # =========================================================
      - name: Clone target repo
        run: |
          git clone https://x-access-token:${{ secrets.DOCS_PUSH_TOKEN }}@github.com/seyun4047/${{ matrix.repo }}.git target

      # =========================================================
      # 4️⃣ COPY FILES
      # =========================================================
      - name: Copy README files
        run: |
          cp README.md target/README.md
          if [ -f README.kr.md ]; then
            cp README.kr.md target/README.kr.md
          fi

      # =========================================================
      # 5️⃣ COMMIT & PUSH
      # =========================================================
      - name: Commit and push
        run: |
          cd target
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add README.md README.kr.md || true
          git commit -m "docs: auto translate + inject cross-language links + sync" || echo "No changes"

          git pull --rebase origin main
          git push origin main
