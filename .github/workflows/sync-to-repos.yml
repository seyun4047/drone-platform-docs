name: Sync docs to component READMEs with Gemini

on:
  push:
    paths:
      - 'components/**.md'
  workflow_dispatch:

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      server: ${{ steps.filter.outputs.server }}
      client: ${{ steps.filter.outputs.client }}
      monitoring: ${{ steps.filter.outputs.monitoring }}
      trans: ${{ steps.filter.outputs.trans }}
      overview: ${{ steps.filter.outputs.overview }}
    steps:
      - uses: actions/checkout@v3
      - name: Detect changed paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            server: ['components/server/server.md']
            client: ['components/client/client.md']
            monitoring: ['components/monitoring-server/monitoring-server.md']
            trans: ['components/trans-tester/trans-tester.md']
            overview: ['components/platform/overview.md']

  sync:
    needs: detect
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - repo: drone-platform-server
            component: server
            condition: ${{ needs.detect.outputs.server == 'true' || needs.detect.outputs.overview == 'true' }}
          - repo: drone-platform-client
            component: client
            condition: ${{ needs.detect.outputs.client == 'true' || needs.detect.outputs.overview == 'true' }}
          - repo: drone-platform-monitoring-server
            component: monitoring-server
            condition: ${{ needs.detect.outputs.monitoring == 'true' || needs.detect.outputs.overview == 'true' }}
          - repo: drone-platform-trans-tester
            component: trans-tester
            condition: ${{ needs.detect.outputs.trans == 'true' || needs.detect.outputs.overview == 'true' }}

    steps:
      - uses: actions/checkout@v3

      - name: Skip if not needed
        if: matrix.condition != 'true'
        run: echo "No changes for ${{ matrix.component }}. Skipping." && exit 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Gemini dependencies
        run: pip install -U google-genai

      - name: Translate changed docs via Gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python - <<EOF
          import os
          # 임포트 경로가 'from google import genai' 여야 합니다.
          from google import genai

          client = genai.Client(api_key=os.environ['GEMINI_API_KEY'])
          MODEL_ID = "gemini-1.5-flash"

          def translate_file(src, dest):
              if not os.path.exists(src): return
              print(f"Translating {src} to {dest}...")
              
              with open(src, 'r', encoding='utf-8') as f:
                  content = f.read()
              
              prompt = f"Translate the following Markdown technical documentation into Korean. Keep all markdown structure, code blocks, and English technical terms intact. Translate only the descriptive text:\n\n{content}"
              
              response = client.models.generate_content(
                  model=MODEL_ID,
                  contents=prompt
              )
              
              with open(dest, 'w', encoding='utf-8') as f:
                  f.write(response.text)

          # 변경 사항 체크 및 번역
          if "${{ needs.detect.outputs[matrix.component] }}" == "true":
              translate_file(f"components/${{ matrix.component }}/${{ matrix.component }}.md", 
                             f"components/${{ matrix.component }}/${{ matrix.component }}.kr.md")
          
          if "${{ needs.detect.outputs.overview }}" == "true":
              translate_file("components/platform/overview.md", "components/platform/overview.kr.md")
          EOF

      - name: Build Final READMEs
        run: |
          # English
          echo "" > README.md
          cat components/${{ matrix.component }}/${{ matrix.component }}.md >> README.md
          echo -e "\n\n---\n" >> README.md
          cat components/platform/overview.md >> README.md

          # Korean
          echo "" > README.kr.md
          [ -f "components/${{ matrix.component }}/${{ matrix.component }}.kr.md" ] && cat "components/${{ matrix.component }}/${{ matrix.component }}.kr.md" >> README.kr.md || cat "components/${{ matrix.component }}/${{ matrix.component }}.md" >> README.kr.md
          echo -e "\n\n---\n" >> README.kr.md
          [ -f "components/platform/overview.kr.md" ] && cat "components/platform/overview.kr.md" >> README.kr.md || cat "components/platform/overview.md" >> README.kr.md

      - name: Clone target repo
        run: |
          git clone https://x-access-token:${{ secrets.DOCS_PUSH_TOKEN }}@github.com/seyun4047/${{ matrix.repo }}.git target

      - name: Sync to Target Repo
        run: |
          cp README.md target/README.md
          cp README.kr.md target/README.kr.md
          cd target
          git config user.name "gemini-bot"
          git config user.email "actions@github.com"
          git add README.md README.kr.md
          git commit -m "docs: sync README & KR translation (Gemini 1.5 Flash)" || echo "No changes"
          git push
